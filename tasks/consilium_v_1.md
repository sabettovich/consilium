# PRD — Consilium v1 (Этап A, учебный кейс «Залив и взыскание ущерба»)

Дата: 2025-10-04
Статус: черновик (готов к реализации)
Ответственный пользователь: Юрист‑человек (оператор)

## 1. Проблема и цель
- Проблема: нет «единой точки» работы с делом: файлы теряются при переименованиях/миграциях, ссылки ломаются, сложно подтверждать целостность.
- Цель: собрать рабочее место юриста на кейсе «залив и взыскание ущерба», где документы получают постоянные ссылки (DocID/PID), лежат в понятной структуре, карточка дела в Obsidian — источник истины, уведомления помогают коммуникации.

## 2. Контекст и связи
- Основание: `doc/plan/roadmap_v1.md` (Этап A: Google Drive + Obsidian + Resolver).
- Диаграмма бизнеса: `doc/plan/ai_law_bureau_sequence.mmd` (RES, GD, NOTIF).
- Тех. последовательность: `doc/plan/AI-Law-Bureau_Project_Full/11_sequence.mmd`.
- Пояснение: `doc/plan/AI-Law-Bureau_Project_Full/03_resolver_guide.md`.

## 3. Пользователь и роли
- Основной пользователь: **Юрист‑человек** (готов выполнять часть шагов вручную; ассистенты вводятся поэтапно).
- Участвующие роли (могут эмулироваться вручную на A): Секретарь (ИИ), Аналитик (ИИ), Сыщик (ИИ), Нотификатор.

## 4. Объём и границы
- Входит (MVP):
  - Регистрация документов через Resolver: `DocID = D-YYYYMMDD-ULID`, `SHA256`, `permalink`.
  - Структура дел в Google Drive: `/Matters/{YEAR}/{MatterID}/` + подпапки.
  - Карточка дела в Obsidian (`.md` в Git) — источник истины, ссылки через Resolver.
  - Уведомления: приём/регистрация; выдача результата; напоминания по срокам (минимум).
  - Проверка целостности: сверка `SHA256` (API/отчёт).
- Вне объёма (на A): SSO/роли/ACL; полный судебный контур; Docassemble; шифрование на клиенте.

## 5. Учебный кейс и данные
- Папка кейса: `demo/Matters/` (анонимизированные/синтетические файлы).
- Пример `MatterID`: `2025-AR-0001` (AR — тип дела), папка на Drive: `/Matters/2025/2025-AR-0001/`.

## 6. Пользовательские сценарии
1) Приём материалов: загрузка PDF/JPG → регистрация через Resolver → получение `permalink` → запись в карточку дела.
2) Формирование досье: карточка дела в Obsidian со списком `DocID` и пометками.
3) Анализ (минимально): ручная передача корпуса Аналитику/Сыщику → возврат выводов → фиксация в досье.
4) Выдача результата: фиксация финалов (PDF/DOCX) → выдача клиенту `permalink` → уведомление (email/Matrix).
5) Проверка целостности: сравнение сохранённого и текущего `SHA256`.

## 7. Функциональные требования
- Регистрация документа:
  - Ввод: `matter_id`, `class` (тип), `title`, бинарный файл.
  - Обработка: присвоить `DocID`, посчитать `SHA256`, загрузить в Drive под `DocID__Название.ext`, записать метаданные в БД.
  - Вывод: `{ doc_id, permalink, sha256, storage, storage_ref }`.
- Перенаправление по `permalink`: `GET /doc/{DocID}` → 302 → фактический URL (Drive).
- Структура дел: автоматическое создание `/Matters/{YEAR}/{MatterID}/` и подпапок: `01_Intake/ 02_Evidence/ 03_Pleadings/ 04_Correspondence/ 05_Court/ 99_Archive/ Client_Share/`.
- Карточка дела: шаблон в `vault/Templates/CaseCard.md`; для каждого дела `vault/Matters/{YEAR}/{MatterID}.md` со ссылками на `permalink` (техметка DocID в комментарии).
- Уведомления: отправка «приём/регистрация» и «выдача результата» (email/Matrix), напоминания от DLINE — минимально.
- Проверка целостности: API для сверки текущего и сохранённого `SHA256`.

## 8. Нефункциональные требования
- Простота развёртывания (1 команда загрузки env + запуск сервиса).
- Логи скачиваний и rate limit на API.
- Безопасность на A: доступ к API по токену; файлы в Drive не публичные; ссылки клиенту — через Resolver.

## 9. Данные и модели (SQLite)
- `matters(matter_id TEXT PK, folder_path TEXT, created_at, status)`
- `docs(doc_id TEXT PK, matter_id TEXT FK, class TEXT, title TEXT, sha256_plain TEXT, storage TEXT, storage_ref TEXT, created_at, updated_at)`
- Дублирование DocID: имя файла; PDF/DOCX/XMP; БД; техметка в Obsidian (`<!--tech: DocID-->`).

## 10. API (минимально достаточный)
- `POST /api/docs/register`
  - form-data: `file`, `matter_id`, `class`, `title`
  - 201: `{ doc_id, permalink, sha256, storage, storage_ref }`
- `GET /doc/{doc_id}` — 302 Redirect → фактический URL Drive
- `GET /api/docs/{doc_id}` — метаданные (включая `sha256`)
- `PATCH /api/docs/{doc_id}` — `storage/storage_ref/title/...` (при переносе/переименовании)
- `POST /api/docs/{doc_id}/verify` — сверка контрольной суммы

Примеры см. `doc/plan/AI-Law-Bureau_Project_Full/03_resolver_guide.md`.

## 11. Интеграции
- Google Drive (без Workspace):
  - Работать по `GDRIVE_ROOT_FOLDER_ID` (папка расшарена на сервисный аккаунт, роль Editor).
  - Создавать структуру `/Matters/{YEAR}/{MatterID}/...` программно.
- Obsidian (в Git): `vault/` в репозитории, карточки дел `vault/Matters/{YEAR}/{MatterID}.md`.

## 12. Критерии приёмки (A–E)
- A) Регистрация возвращает `DocID+SHA256+permalink`, редирект работает.
- B) Файл доступен в `/Matters/{YEAR}/{MatterID}/` на Drive.
- C) Карточка дела в Obsidian содержит ссылку (и техметку DocID).
- D) Уведомления отправляются (email/Matrix) при приёме и выдаче результата.
- E) Проверка целостности доступна: `GET /api/docs/{DocID}` даёт `sha256_stored`, `POST /api/docs/{DocID}/verify` возвращает `sha256_current` и `match`.

## 13. Риски и ограничения
- Квоты/лимиты Google Drive API (скорость/размер/число запросов).
- PII: необходимо следить за именами файлов и метаданными; выполняется ручная санитизация.
- Живучесть: обеспечивается дублированием DocID и резервным экспортом метаданных.
- Нет SSO/ACL на A: доступ по токену (временная мера; риск утечки — минимизируем логами/лимитами).

## 14. План работ и сроки (≤ 2 недели)
- День 1–3: каркас Resolver (эндпойнты, SQLite), загрузка в Drive по `FOLDER_ID`.
- День 4–6: структура дел, редирект, проверка целостности.
- День 7–9: Obsidian vault + карточки дел, уведомления (скрипт/email/Matrix).
- День 10–12: стабилизация, документация, демо на кейсе `demo/Matters`.

## 15. Переменные окружения
- `.env` (см. корень репо):
```
GOOGLE_APPLICATION_CREDENTIALS=$HOME/.config/consilium/gcp-sa.json
GDRIVE_ROOT_FOLDER_ID=<your_folder_id>
GDRIVE_ROOT_PATH=/Matters
```
Перезагрузка в текущую сессию: `set -a; source ./.env; set +a`.

## 16. Приложения
- Шаблон карточки дела: `vault/Templates/CaseCard.md`.
- Диаграммы и гайд см. раздел «Контекст и связи» выше.
