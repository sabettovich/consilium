# Roadmap v1 — Consilium

Дата: 2025-10-04
Статус: согласовано (MVP-фокус подтверждён)

## Цели и рамки
- Основная цель ближайшего цикла (Этап A): поднять Resolver и постоянные ссылки на базе Google Drive + Obsidian.
- «Длинный судебный процесс» — отдельный следующий этап после хранения/идентификаторов (зафиксировано в `doc/plan/ai_law_bureau_note.md`).

## Принципы
- Единство идентификаторов: `MatterID = YYYY-TT-NNNN`, `DocID = D-YYYYMMDD-ULID` (ULID оставляем).
- Отказоустойчивость: DocID дублируется в имени файла, метаданных файла (PDF/DOCX/XMP), БД резолвера, скрытой техметке в Obsidian.
- Источник истины на A: карточки дел в Obsidian (`.md` в Git); файлы — в Google Drive.
- Коммуникации: Matrix/email.
- Безопасность на A: токены, логи скачиваний, rate limit; SSO позже. PII — ручная анонимизация/санитизация (см. `07_security_backup.md`).

## Отказоустойчивые идентификаторы и постоянные ссылки (PID)

- DocID (постоянный идентификатор): присваивается при регистрации, формат `D-YYYYMMDD-ULID`.
- SHA256 (контентный отпечаток): фиксирует конкретную версию файла; позволяет выявлять подмены/повреждения.
- PID-слой (Resolver): ссылка `https://id.домен/doc/<DocID>` не зависит от платформы (Drive → Nextcloud → …).

Дублирование DocID (для живучести):
- Имя файла: префикс `DocID__Название.ext`.
- Метаданные файла (PDF/DOCX/XMP): DocID, MatterID, SHA256.
- База Resolver: DocID, MatterID, class, title, sha256, storage, storage_ref.
- Obsidian: скрытая техметка с DocID в карточке дела.

Критерии приёмки (Этап A):
- Регистрация документа возвращает `doc_id`, `permalink`, `sha256`.
- Ссылка `https://id.домен/doc/<DocID>` работает независимо от перемещений/переименований.
- Доступна проверка целостности по SHA256 (отчёт/эндпойнт).

## Этапы
### Этап A — MVP (Google Drive + Obsidian + Resolver) [2–3 недели]
- Развёртывание Resolver (FastAPI + SQLite).
- API: `POST /api/docs/register`, `GET /doc/{DocID}` (302), `GET/PATCH /api/docs/{DocID}`.
- Интеграция Google Drive (сервисный аккаунт; структура `/Matters/{YEAR}/{MatterID}/`).
- Obsidian: карточки дел `.md` в Git; ссылки только через Resolver.
- Вебхуки: Inbox-демон (входящие) — на Этап A; Docassemble — перенесён на B.
- Сводка «на сегодня»: Matrix/email (минимально).

Критерии готовности A:
- Регистрация документов с DocID и работающие постоянные ссылки.
- Восстановление состояния: Git (Obsidian) + Drive (файлы).

### Этап B — Укрепление [1–2 недели]
- SHA256-отчёт целостности (фоновые проверки), DocID в метаданных PDF/DOCX.
- Базовые ACL резолвера; простая модерация скачиваний; расширение логов.
- Подключение Docassemble по вебхукам (генерация черновиков, регистрация DocID).

### Этап C — Миграция на Nextcloud [1–2 недели]
- `rclone copy` в Nextcloud.
- Обновление Resolver на Nextcloud (WebDAV/fileid), включение версий и аудита.
- Постоянные ссылки сохраняются (через Resolver).

## Диаграммы
- Бизнес-процесс: `doc/plan/ai_law_bureau_sequence.mmd` (обновлено под Resolver/Obsidian/Drive).
- Технологическая последовательность инжеста: `doc/plan/AI-Law-Bureau_Project_Full/11_sequence.mmd`.

## Артефакты
- Полный план и спецификации: `doc/plan/AI-Law-Bureau_Project_Full/`.
- Идея/пояснение: `doc/plan/ai_law_bureau_note.md`.
- Руководство по Resolver для неподготовленного читателя: `doc/plan/AI-Law-Bureau_Project_Full/03_resolver_guide.md`.

## Риски и оговорки
- SSO/роль‑доступы отложены до после A.
- PII и юридическая тайна: на A только санитизация и ограничение доступа по токену.
- Судебный контур — отдельная реализация после завершения A/B.
