# Руководство по Resolver (понятно «с нуля»)

Дата: 2025-10-04
Статус: черновик (Этап A)

## Зачем нужен Resolver
Resolver — это «слой постоянных ссылок». Он даёт стабильный адрес на документ, который не зависит от того, где файл лежит (Google Drive сегодня, Nextcloud завтра).

- Постоянная ссылка (permalink): `https://id.домен/doc/<DocID>`
- При обращении по ссылке Resolver перенаправляет (302 Redirect) на текущее место хранения файла.

## Что такое DocID и SHA256
- DocID — постоянный идентификатор документа. Формат: `D-YYYYMMDD-ULID`.
- SHA256 — отпечаток содержимого. Нужен для контроля целостности и версионирования.

Почему два идентификатора?
- DocID — «имя» документа на всю жизнь. Меняется платформа — DocID тот же.
- SHA256 — «версия» содержимого. Если файл изменился — меняется SHA256.

## Где хранится DocID (отказоустойчивость)
- В имени файла: `DocID__Название.ext` (пример: `D-20251004-...__Isk.pdf`).
- В метаданных файла (PDF/DOCX/XMP): DocID, MatterID, SHA256.
- В базе Resolver: `docs(doc_id, matter_id, title, sha256, storage, storage_ref, ...)`.
- В карточке дела Obsidian: скрытая техметка с DocID.

## Мини-API (Этап A)
- `POST /api/docs/register` — регистрация: присвоить DocID, посчитать SHA256, положить файл, вернуть `doc_id`, `permalink`.
- `GET /doc/{doc_id}` — 302 Redirect на живой URL (Drive/Nextcloud).
- `GET /api/docs/{doc_id}` — метаданные (DocID, MatterID, SHA256, storage, storage_ref).
- `PATCH /api/docs/{doc_id}` — обновить метаданные/местоположение (при миграциях или правках).

## Как пользоваться (сценарий)
1) Секретарь отправляет файл на регистрацию в Resolver.
2) Resolver присваивает DocID, сохраняет файл в Google Drive, отдаёт permalink.
3) Секретарь использует permalink в досье/выдаче клиенту и в уведомлениях.
4) При обновлениях/переносах — вызывать `PATCH`, ссылка остаётся прежней.

## Миграция (Drive → Nextcloud)
- Файлы копируются (например, `rclone`) в Nextcloud.
- У Resolver меняется `storage` и `storage_ref` на Nextcloud.
- Все старые ссылки `https://id.домен/doc/<DocID>` продолжают работать.

## Безопасность (Этап A)
- Токены доступа к API, CORS/Rate limit.
- Логи скачиваний (кто, когда, что запрашивал).
- PII: перед регистрацией — санитизация (удаление персональных данных из открытых метаданных/имён).

## Частые вопросы
- Что если файл переименовали? — Не страшно: DocID в имени файла — дублирование; ссылка зависит от DocID, а не от имени.
- Что если файл переместили? — Обновите `storage_ref` через `PATCH`.
- Как проверить, что файл не сломался? — Сверьте SHA256.
- Можно ли иметь несколько версий? — Да: DocID постоянный, а SHA256 меняется на каждую версию; историю версий хранит хранилище/БД.
