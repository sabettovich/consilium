sequenceDiagram
    autonumber
    %% Участники
    participant C as Клиент
    participant SEC as Секретарь (ИИ)
    participant RES as Resolver (постоянные ссылки)
    participant GD as Google Drive (хранилище)
    participant OCR as OCR/Классификация
    participant AN as Аналитик (ИИ)
    participant INV as Сыщик (ИИ)
    participant SPEC as Узкий специалист(ы) (ИИ-модули)
    participant LAW as Юрист-Человек
    participant CONS as Внешний консультант (человек)
    participant NOTIF as Нотификатор (email/SMS/месс.)
    participant COURT as Суд/Ведомство (единый процесс)
    participant DLINE as Контроль сроков (проц. + SLA)
    participant ARCH as Архив/Деперсонализация

    %% 1) Вход — всегда через Секретаря
    C->>SEC: 1) Передача документов/запроса
    SEC->>RES: Зарегистрировать документ (присвоить DocID)
    RES->>GD: Загрузить файл DocID__Название.ext
    GD-->>RES: fileId / webViewLink
    RES-->>SEC: permalink https://id.домен/doc/DocID
    SEC->>GD: Создать структуру папок кейса (при необходимости)
    SEC-->>C: Подтверждение приёма + чек-лист недостающих файлов
    SEC->>DLINE: Создать календарь сроков по делу (базовые SLA)
    SEC->>NOTIF: Уведомление о регистрации (DocID, ссылка)

    %% 2) Предобработка
    GD->>OCR: Запуск OCR/классификации (если сканы)
    OCR-->>GD: Тексты + метаданные (типы, стороны, даты)

    %% 3) Разветвление на Аналитика и Сыщика
    GD->>AN: Передать корпус (тексты + мета)
    SEC->>INV: Список фактов/вопросов для поиска
    INV->>AN: Релевантные нормы/прецеденты/источники
    AN-->>SEC: Черновой отчёт: факты, риски, вопросы

    %% 4) Передача Юристу и уточнения
    SEC->>LAW: Досье (отчёт + источники + документы)
    LAW-->>SEC: Уточняющие вопросы клиенту
    SEC-->>C: Вопросы по фактам/материалам
    C-->>SEC: Ответы/доп.файлы
    SEC->>RES: Зарегистрировать новые файлы (DocID) / обновить метаданные
    RES->>GD: Положить/обновить файл
    GD-->>RES: fileId / webViewLink
    RES-->>SEC: permalink на новые/обновлённые файлы
    SEC->>AN: Обновить анализ с учётом ответов
    AN-->>SEC: Обновлённый отчёт/проект документа

    %% 5) Узкий специалист (по необходимости)
    alt Нужна тематическая экспертиза
        SEC->>SPEC: Релевантный поднабор материалов
        SPEC-->>SEC: Заключение/правки
        SEC->>AN: Учесть выводы специалиста
        AN-->>SEC: Версия к проверке
    end

    %% 6) Финальная проверка и (опционально) внешний консультант
    SEC->>LAW: Проект документа (иск/договор/мемо)
    opt Привлечь внешнего консультанта
        LAW->>CONS: Проект + контекст
        CONS-->>LAW: Комментарии/правки
    end
    LAW-->>SEC: Итоговые правки/утверждение

    %% 7) Выдача и уведомления
    SEC->>RES: Зарегистрировать финальные файлы (DocID)
    RES->>GD: Зафиксировать финальные файлы (PDF/DOCX)
    RES-->>SEC: permalink на финальные файлы
    SEC-->>C: Выдача результата + permalink
    SEC->>NOTIF: Отправить уведомления/ссылки клиенту

    %% 8) Подача и единый судебный процесс (все инстанции как один «длинный суд»)
    alt Клиент поручает подачу
        SEC->>LAW: Запрос на подачу
        LAW->>COURT: Подача пакета документов
        COURT-->>LAW: Подтверждение/уведомления/запросы
        SEC->>DLINE: Задать процессуальные сроки (ответы, заседания, обжалование)

        loop Судебный процесс (единый контур)
            COURT-->>LAW: Заседания/определения/запросы/решения
            LAW->>SEC: Задания на материалы/реакции
            SEC->>AN: Обновить анализ позиции
            AN-->>LAW: Рекомендации/проекты ответов/ходатайств
            SEC->>RES: Регистрация/обновление документов
            RES->>GD: Обновить папку кейса

            %% Контроль сроков по процессу
            DLINE-->>SEC: Напоминание о дедлайне (T-3/T-1/в день)
            SEC->>LAW: Эскалация по срокам + чек-лист действий
            SEC->>C: Уведомления о ключевых датах (при необходимости)
            SEC->>NOTIF: Рассылка напоминаний/дедлайнов
            alt Риск пропуска срока
                SEC->>LAW: Триггер «высокий риск» (красный)
                LAW->>SEC: Срочные меры (ходатайство о восстановлении, курьер, эл.подпись)
                SEC->>DLINE: Отметить антикризисные шаги и новые сроки
            end

            %% Итерации до итогового акта последней инстанции
        end

        COURT-->>LAW: Итоговый акт по делу (последняя инстанция/исполнение)
        LAW->>SEC: План финализации/исполнения
        SEC->>DLINE: Закрыть процессуальные задачи, снять напоминания
        SEC->>NOTIF: Сообщить клиенту о результате/следующих шагах
    end

    %% 9) Обратный поток от клиента
    C-->>SEC: Исправленные/доп. документы, подписи
    SEC->>RES: Зарегистрировать/обновить документ
    RES->>GD: Сохранить в кейс
    SEC->>AN: Перепроверка при необходимости
    AN-->>SEC: Обновлённая версия/мемо изменений
    SEC->>LAW: Финальный контроль

    %% 10) Закрытие и архив
    SEC->>ARCH: Архивация кейса по политике хранения
    ARCH-->>SEC: Подтверждение (анонимизация/сроки хранения)

